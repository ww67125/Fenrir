# 一、攻击
### 1. arp 攻击原理
arp攻击只能存在局域网中，并且局域网中有一个发动攻击的**中间人**
![d7gvsouo](/assets/d7gvsouo.bmp)
- 在有交换机和路由器的局域网中
- pc1发送arp请求询问pc2的mac地址，由于采用广播方式，路由设备将广播发送到各个机器，
- pc2收到广播回应自己的arp包，中间人处于监听状态，没有返回arp包
- pc1和pc2根据交互的arp包，存储arp表到缓存
- 交换机根据学习机制，记录mac对应接口信息存在cam缓存表（mac对应端口）。收到数据包时，解封数据根据mac转发。
（交换机基于源mac地址学习，基于目的mac地址转发）
  表名    | 对映射信息
  --------|-------------
  ARP表   | ip<->mac
  CAM表   | mac<->port
  Route表 | route<->port
- 目前中间人处于被动监听阶段
- pc3监听到发送的广播包，并没有丢弃，同样返回pc2的ip和自己mac地址发起欺骗
- pc1接收到两个ip为ip2的arp包，采用**后到优先**原则（cam表同样后到优先）
- 为防止自己的arp包并不优先，arp攻击工具会采取主动扫描的形式在短时间高并发网络扫描，持续发出欺骗报以覆盖正常arp表
- 交换机收到数据包时，发现是pc3的mac地址，查看cam表对应port3，因此会转发到pc3
### 2. 常见攻击形式
1. 断网攻击：将欺骗到的数据包直接丢弃，如果原本转发目标是出口路由，请求的机器就无法联网。
2. 限速攻击： 同断网攻击，只是限制了传输的速度。
3. 数据窃取：如果是基于http的明文传输，账号密码会被窃取，还有telnet，ftp，邮箱等应用。也可以监控上网行为
### 3. 常用arp工具
- 仅具备arp扫描功能，用来发现主机：metasploit里arping/arpscan等模块
- ARP扫描+流量控制（限速或限制能上哪些网站和应用）；例如Windows下的P2P终结者；
- ARP扫描+账号窃取（网站、邮箱、各种）；最强的莫过于Windows下的Cain，当然还有跨平台的Ettercap（需配合其他工具）；
  #### 主动扫描攻击手段
  其一：主动发动攻击过程，向所有ip发送请求的arp包广播，来扫描网段所有ip，并向所有人回复，自己就是所有人，将所有ip都对应上自己的mac

  其二：发动攻击，告诉所有人，自己就是网关，此时所有流量经过中间人
# 二、防御
### 1. 防御原理
  - 保证电脑不接收欺骗包
  - 保证电脑收到欺骗包之后不相信
### 2. 防御方法
  - 当黑客发起ARP欺骗包时，会途径局域网里面的交换机或无线路由器等网络设备；
  - 如果网络设备能够识别这种欺骗包，并且提前丢弃掉，则电脑/手机端就不会被欺骗；
    #### 主流技术
    - 基于网络设备的防御DAI(Dynamic ARP Inspection）- **动态ARP检测** ，即记录每个接口的对应的ip和mac（port<->mac<->ip），生成DAI检测表。
    - 之后交换机检测接口发送的arp包，根据DAI检测是否违规，若违规就丢弃数据包并惩罚
    - DAI的生成主要依赖于两种方法
      1. 手工静态绑定，管理员根据用户电脑mac和ip，对应好接口绑定。
      2. 设备开启DHCP侦听，用户第一次通过dhcp获取地址时，生成dhcp侦听表（如同DAI表的功能）
      **大部分情况下，非企业级网络设备不支持DAI技术**
  - 如果网络设备没有拦截这种欺骗包，则电脑/手机端需要做安全防御，然后再丢弃。
    #### 个人设备主流防御技术
    - 不接入陌生或没有安全性的网络！（例如酒店，咖啡店等公共场所）
    - 安装arp防火墙
      1. 能绑定正确ip和mac，受到攻击时不被欺骗
      2. 识别局域网的arp扫描和欺骗，找到攻击者的ip和mac。
      3. 常用安全产品腾讯电脑管家，360安全卫士等实现了arp防御
      4. 专业arp防火墙
    - ARP双向绑定（即手工静态绑定ipmac地址）
      - windows绑定方法
        1. 进入cmd
        2.  [arp -s ip地址 mac地址]，例如：arp -s 192.168.1.1 00-11-22-a1-c6-09（家用路由器绑定需要通过web界面操作）
